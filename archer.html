<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Archery - Sağ Kenar Referans Sistemi</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #87ceeb; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        canvas { display: block; }
        .video-input { visibility: hidden; position: absolute; }
        
        /* Kamera: Orta-Üst, Küçük, Aynalı */
        .camera-preview {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%); 
            width: 160px; height: 120px;
            border: 3px solid #fff; border-radius: 15px; background: #000;
            overflow: hidden; z-index: 50; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .camera-preview canvas { width: 100%; height: 100%; transform: scaleX(-1); }
        
        #loading-overlay {
            position: fixed; inset: 0; background: #0f172a;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; color: white;
        }
        .loader {
            border: 4px solid #1e293b; border-top: 4px solid #38bdf8;
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="loader"></div>
        <h1 class="text-xl font-bold mb-2">Elite Archery Kalibrasyonu...</h1>
        <p class="text-sky-400 text-sm italic">Sağ kenardan sola doğru çekerek nişan alın.</p>
    </div>

    <video class="video-input"></video>
    <canvas id="gameCanvas"></canvas>

    <!-- UI Overlay -->
    <div class="absolute top-4 left-4 pointer-events-none">
        <div class="bg-white/95 backdrop-blur p-4 rounded-2xl shadow-xl border border-white/50">
            <h2 class="text-xl font-black text-slate-800 tracking-tighter uppercase italic">ARCHERY ELITE</h2>
            <div class="mt-2 flex gap-4">
                <div class="text-center">
                    <p class="text-[8px] text-slate-500 uppercase font-black">OK</p>
                    <p id="arrow-display" class="text-xl font-black text-blue-600">20</p>
                </div>
                <div class="text-center border-l border-slate-300 pl-4">
                    <p class="text-[8px] text-slate-500 uppercase font-black">PUAN</p>
                    <p id="score-display" class="text-xl font-black text-orange-600">0</p>
                </div>
            </div>
            <div id="status-ui" class="mt-2 flex items-center gap-2">
                <div id="status-dot" class="w-2 h-2 rounded-full bg-red-500"></div>
                <span id="status-text" class="text-[8px] font-bold text-slate-500 uppercase">TAKİP BEKLENİYOR</span>
            </div>
        </div>
    </div>

    <div class="camera-preview">
        <canvas id="previewCanvas"></canvas>
    </div>

    <script>
        /**
         * SES SİSTEMİ
         */
        const sfx = {
            release: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'),
            hit: new Audio('https://assets.mixkit.co/active_storage/sfx/133/133-preview.mp3'),
            stretch: new Audio('https://assets.mixkit.co/active_storage/sfx/599/599-preview.mp3')
        };

        function playSFX(name) {
            const sound = sfx[name].cloneNode();
            sound.volume = 0.5;
            sound.play().catch(() => {});
        }

        /**
         * OYUN MOTORU
         */
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const previewCanvas = document.getElementById('previewCanvas');
        const previewCtx = previewCanvas.getContext('2d');
        const videoElement = document.querySelector('.video-input');

        const GRAVITY = 0.20;
        const POWER_SCALE = 0.15; // Değişken adı POWER_SCALE olarak sabitlendi

        let gameState = {
            arrowsLeft: 20, score: 0,
            entities: [], targets: [], clouds: [],
            
            // Sabit Archer Konumu (Ekranın Solu)
            archerX: 180,
            archerY: 0,
            pivotY: 0,

            // El ve Takip Durumu
            handActive: false,
            isDrawing: false,
            pullStrength: 0,
            currentAngle: 0,
            lastHandPos: { x: 0, y: 0 }
        };

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            previewCanvas.width = 640;
            previewCanvas.height = 480;
            gameState.archerY = canvas.height * 0.72;
            gameState.pivotY = gameState.archerY - 35;
            initBG();
        }
        window.addEventListener('resize', resize);

        function initBG() {
            gameState.clouds = [];
            for(let i=0; i<8; i++) {
                gameState.clouds.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height * 0.35,
                    sp: 0.1 + Math.random() * 0.3,
                    sz: 35 + Math.random() * 55
                });
            }
            gameState.targets = [];
            for(let i=0; i<3; i++) spawnTarget();
        }

        function spawnTarget() {
            gameState.targets.push({
                x: canvas.width * (0.65 + Math.random() * 0.25),
                y: 100 + Math.random() * (canvas.height - 300),
                r: 40 + Math.random() * 15,
                dir: Math.random() > 0.5 ? 1 : -1,
                speed: 1.2 + Math.random() * 1.8
            });
        }

        class Arrow {
            constructor(x, y, vx, vy, angle) {
                this.x = x; this.y = y;
                this.vx = vx; this.vy = vy;
                this.angle = angle;
                this.isStuck = false;
                this.len = 100;
                this.life = 600;
            }
            update() {
                if (this.isStuck) { this.life--; return; }
                this.vy += GRAVITY;
                this.x += this.vx; this.y += this.vy;
                this.angle = Math.atan2(this.vy, this.vx);

                if (this.y > canvas.height - 50) {
                    this.y = canvas.height - 50; this.isStuck = true; playSFX('hit');
                }
                if (this.x > canvas.width) this.life = 0;

                gameState.targets.forEach(t => {
                    const dist = Math.hypot(this.x - t.x, this.y - t.y);
                    if (!this.isStuck && dist < t.r) {
                        this.isStuck = true;
                        this.stuckTarget = t;
                        this.offset = { dx: this.x - t.x, dy: this.y - t.y };
                        playSFX('hit');
                        gameState.score += Math.max(10, Math.round(200 - dist));
                        updateUI();
                    }
                });
            }
            draw(ctx) {
                ctx.save();
                if (this.isStuck && this.stuckTarget) ctx.translate(this.stuckTarget.x + this.offset.dx, this.stuckTarget.y + this.offset.dy);
                else ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                
                // OK ÇİZİMİ
                ctx.strokeStyle = '#3d2b1f'; ctx.lineWidth = 5;
                ctx.beginPath(); ctx.moveTo(-this.len/2, 0); ctx.lineTo(this.len/2, 0); ctx.stroke();
                // Uc
                ctx.fillStyle = '#bdc3c7'; ctx.beginPath(); ctx.moveTo(this.len/2, 0); ctx.lineTo(this.len/2-20, -10); ctx.lineTo(this.len/2-20, 10); ctx.closePath(); ctx.fill();
                // Tüyler
                ctx.fillStyle = '#e74c3c'; ctx.fillRect(-this.len/2, -8, 20, 4); ctx.fillRect(-this.len/2, 4, 20, 4);
                ctx.restore();
            }
        }

        /**
         * MEDIAPIPE EL TAKİBİ
         */
        const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });

        function onResults(results) {
            document.getElementById('loading-overlay').style.display = 'none';
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');

            previewCtx.save();
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
            previewCtx.drawImage(results.image, 0, 0, previewCanvas.width, previewCanvas.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                gameState.handActive = true;
                statusDot.className = "w-2 h-2 rounded-full bg-green-500";
                statusText.innerText = "TAKİP AKTİF";

                const lm = results.multiHandLandmarks[0];
                drawConnectors(previewCtx, lm, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 4});

                // Ayna koordinatları (Kamera aynalı olduğu için 1-x yapıyoruz)
                const mx = (1 - lm[9].x) * canvas.width;
                const my = lm[9].y * canvas.height;
                gameState.lastHandPos = { x: mx, y: my };

                // SAĞ KENAR REFERANS SİSTEMİ
                // El en sağdayken (mx = width) çekiş 0 olmalı.
                // El sola doğru gittikçe çekiş artmalı.
                const pullRefX = canvas.width - 200; 
                const dx_pull = Math.max(-200,pullRefX - mx);
                const dy_angle = gameState.pivotY - my;

                // Yay her zaman elin dikey konumuna göre nişan alır (Daima sağa bakar)
                gameState.currentAngle = Math.atan2(dy_angle, dx_pull + 100); 

                // Tetik: Baş parmak ucu (4) - İşaret parmağı (5) yakınlığı
                const distTrigger = Math.hypot(lm[4].x - lm[5].x, lm[4].y - lm[5].y);
                const isThumbTriggered = distTrigger < 0.08;

                if (isThumbTriggered) {
                    if (!gameState.isDrawing) {
                        gameState.isDrawing = true;
                        playSFX('stretch');
                    }
                    // Güç çekiş mesafesine bağlıdır (dx_pull sola doğru gittikçe artar)
                    gameState.pullStrength = Math.min(dx_pull, 450);
                } else if (gameState.isDrawing) {
                    // RELEASE
                    fireArrow();
                    gameState.isDrawing = false;
                    gameState.pullStrength = 0;
                }
            } else {
                gameState.handActive = false;
                statusDot.className = "w-2 h-2 rounded-full bg-red-500 animate-pulse";
                statusText.innerText = "EL BEKLENİYOR";
                gameState.isDrawing = false;
            }
            previewCtx.restore();
        }

        function fireArrow() {
            if (gameState.arrowsLeft <= 0) return;
            const p = gameState.pullStrength * POWER_SCALE;
            // Daima sağdaki hedeflere doğru fırlatılır
            const vx = Math.cos(gameState.currentAngle) * p;
            const vy = Math.sin(gameState.currentAngle) * p;
            
            gameState.entities.push(new Arrow(gameState.archerX + 50, gameState.pivotY, vx, vy, gameState.currentAngle));
            gameState.arrowsLeft--; playSFX('release'); updateUI();
        }

        hands.onResults(onResults);
        new Camera(videoElement, { onFrame: async () => { await hands.send({image: videoElement}); }, width: 640, height: 480 }).start();

        /**
         * GÖRSEL SİSTEM
         */
        function drawArcherStatic(ctx, x, y) {
            ctx.strokeStyle = '#2c3e50'; ctx.lineWidth = 6; ctx.lineCap = 'round';
            ctx.beginPath(); ctx.arc(x, y - 55, 15, 0, Math.PI * 2); ctx.stroke(); // Head
            ctx.beginPath(); ctx.moveTo(x, y - 40); ctx.lineTo(x, y + 25); ctx.stroke(); // Body
            ctx.beginPath(); ctx.moveTo(x, y + 25); ctx.lineTo(x - 15, y + 60); ctx.stroke(); // Legs
            ctx.beginPath(); ctx.moveTo(x, y + 25); ctx.lineTo(x + 15, y + 60); ctx.stroke();
        }

        function drawBowComplex(ctx, px, py, angle, pull) {
            ctx.save();
            ctx.strokeStyle = '#2c3e50'; ctx.lineWidth = 6; ctx.lineCap = 'round';
            
            // Yayın omuz pivotu
            const handX = px + Math.cos(angle) * 55;
            const handY = py + Math.sin(angle) * 55;
            ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(handX, handY); ctx.stroke(); // Yay kolu

            const pullBackX = handX - Math.cos(angle) * (pull * 0.45);
            const pullBackY = handY - Math.sin(angle) * (pull * 0.45);
            ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(pullBackX, pullBackY); ctx.stroke(); // Çekiş kolu

            // YAY GÖVDESİ
            ctx.save();
            ctx.translate(handX, handY);
            ctx.rotate(angle);
            ctx.strokeStyle = '#5d4037'; ctx.lineWidth = 10;
            ctx.beginPath(); ctx.arc(0, 0, 105, -Math.PI/2, Math.PI/2); ctx.stroke(); // Wood
            
            ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(0, -105); ctx.lineTo(-pull*0.45, 0); ctx.lineTo(0, 105); ctx.stroke(); // Kiriş
            
            // Kirişteki Ok
            if (gameState.isDrawing) {
                ctx.save(); ctx.translate(-pull*0.45, 0);
                ctx.strokeStyle = '#3d2b1f'; ctx.lineWidth = 5;
                ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(120, 0); ctx.stroke();
                ctx.fillStyle = '#bdc3c7'; ctx.beginPath(); ctx.moveTo(120,0); ctx.lineTo(105,-8); ctx.lineTo(105,8); ctx.closePath(); ctx.fill();
                ctx.restore();
            }
            ctx.restore();
            ctx.restore();
        }

        function drawTrajectory(startX, startY, vx, vy) {
            ctx.save();
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            let tx = startX, ty = startY, tvx = vx, tvy = vy;
            for(let i=0; i<45; i++) {
                tvy += GRAVITY; tx += tvx; ty += tvy;
                if (i % 3 === 0) {
                    ctx.beginPath(); ctx.arc(tx, ty, 4, 0, Math.PI*2); ctx.fill();
                }
                if (ty > canvas.height - 50 || tx > canvas.width) break;
            }
            ctx.restore();
        }

        function updateUI() {
            document.getElementById('arrow-display').innerText = gameState.arrowsLeft;
            document.getElementById('score-display').innerText = gameState.score;
        }

        function loop() {
            // Background
            const bg = ctx.createLinearGradient(0, 0, 0, canvas.height);
            bg.addColorStop(0, '#00d2ff'); bg.addColorStop(1, '#a29bfe');
            ctx.fillStyle = bg; ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Scenery
            ctx.fillStyle = '#f1c40f'; ctx.beginPath(); ctx.arc(80, 80, 40, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,0.7)';
            gameState.clouds.forEach(c => {
                c.x += c.sp; if(c.x > canvas.width + 100) c.x = -100;
                ctx.beginPath(); ctx.ellipse(c.x, c.y, c.sz, c.sz*0.45, 0, 0, Math.PI*2); ctx.fill();
            });

            // Ground
            ctx.fillStyle = '#2ecc71'; ctx.fillRect(0, canvas.height-50, canvas.width, 50);

            // Targets
            gameState.targets.forEach(t => {
                t.y += t.dir * t.speed;
                if (t.y < 120 || t.y > canvas.height - 220) t.dir *= -1;
                ctx.save(); ctx.translate(t.x, t.y);
                const rings = ['#fff', '#000', '#3498db', '#e74c3c', '#f1c40f'];
                for(let i=0; i<5; i++) {
                    ctx.fillStyle = rings[i]; ctx.beginPath(); ctx.arc(0,0, t.r*(1-i*0.2), 0, Math.PI*2); ctx.fill();
                }
                ctx.restore();
            });

            // Entities
            gameState.entities = gameState.entities.filter(e => e.life > 0);
            gameState.entities.forEach(e => { e.update(); e.draw(ctx); });

            // Archer
            drawArcherStatic(ctx, gameState.archerX, gameState.archerY);

            // Yay ve Nişan Çizgisi
            if (gameState.handActive) {
                if (gameState.isDrawing) {
                    const p = gameState.pullStrength * POWER_SCALE; // POWER_SCALE kullanıldı
                    drawTrajectory(gameState.archerX + 50, gameState.pivotY, Math.cos(gameState.currentAngle)*p, Math.sin(gameState.currentAngle)*p);
                }
                drawBowComplex(ctx, gameState.archerX, gameState.pivotY, gameState.currentAngle, gameState.pullStrength);
            } else {
                drawBowComplex(ctx, gameState.archerX, gameState.pivotY, 0, 0);
            }

            requestAnimationFrame(loop);
        }

        window.onload = () => { resize(); loop(); };
    </script>
</body>
</html>